name: Create Release

on:
  push:
    branches: [master]
  pull_request:
    types: [closed]
    branches: [master]
  workflow_dispatch:

jobs:
  release:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install dependencies
        run: pip install pyyaml beet bolt mecha stewbeet==2.3.13 stouputils==1.10.4

      - name: Get version from beet.yaml
        id: version
        run: |
          BEET_VERSION=$(python -c "import yaml; print(yaml.safe_load(open('beet.yaml'))['version'])")
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "version=${BEET_VERSION}-${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: Build project
        run: |
          export PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1
          beet build

      - name: Archive build artifacts
        run: |
          VERSION=${{ steps.version.outputs.version }}
          
          cd build/yw-pillar-datapack
          zip -r "../../yw-pillar-datapack-${VERSION}.zip" .
          cd ../../
          
          cd build/yw-pillar-resourcepack
          zip -r "../../yw-pillar-resourcepack-${VERSION}.zip" .
          cd ../../

      - name: Generate Changelog
        id: changelog
        shell: bash
        run: |
          {
            echo "log<<EOF"
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              echo "Merged PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }} (@${{ github.event.pull_request.user.login }})"
            elif [ "${{ github.event_name }}" = "push" ]; then
              # 获取当前 Push 包含的所有提交 (from..to)
              git log --format="- [%h](https://github.com/${{ github.repository }}/commit/%H) %s" ${{ github.event.before }}..${{ github.event.after }} || git log -1 --format="- [%h](https://github.com/${{ github.repository }}/commit/%H) %s"
            else
              echo "Manual trigger / Snapshot release"
              git log -1 --format="- [%h](https://github.com/${{ github.repository }}/commit/%H) %s"
            fi
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: |
            ## Changes in this version
            ${{ steps.changelog.outputs.log }}
          files: |
            yw-pillar-datapack-${{ steps.version.outputs.version }}.zip
            yw-pillar-resourcepack-${{ steps.version.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}